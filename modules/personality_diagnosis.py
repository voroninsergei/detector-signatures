"""Модуль вероятностной диагностики пола, возраста и психологических особенностей.

Методики из литературы Орловой предполагают вероятностные выводы. Здесь
реализованы очень простые эвристики, которые могут дать грубую оценку
пола (мужчина/женщина) и возраста (молодой/средний/пожилой) на основе
размера букв, наклона и разгона. Эти правила не обладают высокой
точностью и служат лишь демонстрацией подхода.
"""

from . import preprocessing, general_features


def analyze_personality(image_path: str) -> str:
    """Пытается определить пол и возраст автора на основе почерка.

    :param image_path: путь к изображению
    :return: текстовый отчёт с вероятностной оценкой
    """
    try:
        image = preprocessing.load_image(image_path)
    except FileNotFoundError as exc:
        return str(exc)
    proc = preprocessing.preprocess_image(image)
    size, _ = general_features.compute_letter_sizes(proc)
    spacing, _ = general_features.compute_spacing(proc)
    slant = general_features.compute_slant(proc)
    # Эвристики: крупный размер и широкий разгон встречаются чаще у мужчин,
    # мелкий размер и узкий разгон – у женщин. Наклон вправо характерен для
    # динамичного письма (молодой/средний возраст), наклон менее выражен у
    # пожилых.
    if size > 30 and spacing > 6:
        gender = 'мужчина'
    elif size < 15 and spacing < 4:
        gender = 'женщина'
    else:
        gender = 'неопределён'
    # Возраст: сильный правый наклон (>10°) – часто молодые; умеренный (5–10°)
    # – средний возраст; наклон близок к прямому – пожилой или спокойный почерк.
    if slant > 10:
        age = 'молодой'
    elif slant > 5:
        age = 'средний'
    else:
        age = 'пожилой/спокойный почерк'
    return (
        f"Диагностика личности ({image_path}):\n"
        f"Предполагаемый пол: {gender}\n"
        f"Предполагаемый возраст: {age}\n"
        f"(Размер: {size:.1f} px, разгон: {spacing:.1f} px, наклон: {slant:.1f}°)\n"
        "Выводы являются ориентировочными и могут быть неточными."
    )